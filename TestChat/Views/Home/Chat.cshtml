@using TestChat.Models.ViewModels
@model ChatViewModel
@{
    ViewBag.Title = "Chat";
}
<script src="~/Scripts/jquery-3.3.1.js"></script>
<!--Ссылка на библиотеку SignalR -->
<script src="~/Scripts/jquery.signalR-2.3.0.js"></script>
<script src="~/signalr/hubs"></script>


<div class="chat">
    <div id="results" class="results scrollable chat-view">
    </div>
    <div class="newMessages">New mesages</div>
    <div class="chat-input">
        <input class="message-text" placeholder="Your message..." type="text" name="Message" id="input" />
        <button class="message-button" id="go" type="submit">Go</button>
    </div>
</div>

<script>
    $(document).ready(function () {
        var chat = $.connection.chutHub;
        var newMessageDiv = $(".newMessages");


        newMessageDiv.bind("click", function () {
            scrollToBotton();
        });
        $("#results").scroll(function () {

            if ($(".scrollable")[0].scrollHeight - ($(".scrollable").scrollTop() + $(".scrollable").height())  < $(".message").last().height()) {
                newMessageDiv.hide();
            }
        });
        var prevCount = 0;
        function scrollToBotton() {
            newMessageDiv.hide();
            $(".scrollable").scrollTop($(".scrollable")[0].scrollHeight);
        }
        var uri =  @Html.Raw(HttpUtility.JavaScriptStringEncode(
                  new Uri(new Uri(this.Context.Request.Url.GetLeftPart(UriPartial.Authority)),
                  Url.Content("~/Home/Messages")
                  ).ToString(), true));
                var uri1 =  @Html.Raw(HttpUtility.JavaScriptStringEncode(
                  new Uri(new Uri(this.Context.Request.Url.GetLeftPart(UriPartial.Authority)),
                  Url.Content("~/Home/GetLastMessageCount")
                  ).ToString(), true));
        var first = true;
        function sendMessage(message,fromMe) {
            prevCount = $(".message").length;
            var scrollFromTop = $(".scrollable").scrollTop() + $(".scrollable").height();
            var scrollHeight = $(".scrollable")[0].scrollHeight;
            var lastMessageheight = $(".message").last().height();
            $.get(uri1, function (data) {
                if (prevCount == parseInt(data)&&!message) return;
            $("#results").load(uri, { Message: message }, function () {
                if (message) {
                    $("#input")[0].value = "";
                }
                var count = $(".message").length;
                if ((count != prevCount && scrollHeight - scrollFromTop < lastMessageheight) || first || fromMe) {
                    first = false;
                    fromMe = false;
                    scrollToBotton();
                }
                if (count != prevCount && scrollHeight - scrollFromTop > lastMessageheight) {
                    newMessageDiv.show();
                }
                else {
                    if (!newMessageDiv.is(":visible"))
                        newMessageDiv.hide();
                }
                });
            });

        }
        function sendMessageFromInput() {
            sendMessage($("#input")[0].value, true);
            chat.server.send();
        }
        $("#go").bind("click", sendMessageFromInput);
        $("#input").bind("keypress", function (e) {
            if (e.keyCode ==13) {
                sendMessageFromInput();
                chat.server.send();
            }
        });
        function autoClick() {
            sendMessage("", false);
        }
        chat.client.addMessage = function () {
            autoClick();
        }
        $.connection.hub.start().done(function () {
            chat.server.send();
        });
        autoClick();

    });
</script>

